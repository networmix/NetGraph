# Test scenario 3: Complex 3-tier Clos network with nested blueprints
# Tests advanced blueprint nesting, node/link overrides, and capacity probing
seed: 3003

blueprints:
  brick_2tier:
    nodes:
      t1:
        count: 4
        template: t1-{n}
      t2:
        count: 4
        template: t2-{n}

    links:
      - source: /t1
        target: /t2
        pattern: mesh
        capacity: 100.0 # 100 Gb/s tier1-tier2 links
        cost: 1

  3tier_clos:
    nodes:
      b1:
        blueprint: brick_2tier
      b2:
        blueprint: brick_2tier
      spine:
        count: 16
        template: t3-{n}

    links:
      - source: b1/t2
        target: spine
        pattern: one_to_one
        capacity: 400.0 # 400 Gb/s tier2-spine links
        cost: 1
      - source: b2/t2
        target: spine
        pattern: one_to_one
        capacity: 400.0 # 400 Gb/s tier2-spine links
        cost: 1

network:
  name: "3tier_clos_network"
  version: 1.0

  nodes:
    my_clos1:
      blueprint: 3tier_clos

    my_clos2:
      blueprint: 3tier_clos

  links:
    - source: my_clos1/spine
      target: my_clos2/spine
      pattern: one_to_one
      capacity: 400.0 # 400 Gb/s inter-Clos spine links
      cost: 1

  link_rules:
    # Overriding a link between two spine devices.
    - source: my_clos1/spine/t3-1$
      target: my_clos2/spine/t3-1$
      capacity: 200.0 # Override capacity to 200 Gb/s
      cost: 1

    # Set fiber conduit risk groups and hw_component on all spine to spine links
    # These inter-clos links traverse a fiber conduit between buildings
    - source: .*/spine/.*
      target: .*/spine/.*
      bidirectional: True
      risk_groups: ["Conduit_InterClos_C1"]
      attrs:
        fiber:
          conduit_id: "InterClos-C1"
          path_id: "Clos1-Clos2"
        hardware:
          source: {component: "400G-LR4", count: 1}
          target: {component: "400G-LR4", count: 1}

  # Node overrides for facility-based risk groups
  node_rules:
    - path: my_clos1/b1/t1
      risk_groups: ["PowerZone_Clos1_B1_PZA"]
      attrs:
        facility:
          building_id: "Clos1"
          room_id: "B1"
          power_zone: "Clos1-B1-PZ-A"
        hw_component: "LeafHW-A"

    - path: my_clos2/b2/t1
      risk_groups: ["PowerZone_Clos2_B2_PZA"]
      attrs:
        facility:
          building_id: "Clos2"
          room_id: "B2"
          power_zone: "Clos2-B2-PZ-A"
        hw_component: "LeafHW-B"

    - path: my_clos1/spine/t3.*
      risk_groups: ["Room_Clos1_Spine"]
      attrs:
        facility:
          building_id: "Clos1"
          room_id: "Spine"
        hw_component: "SpineHW"

    - path: my_clos2/spine/t3.*
      risk_groups: ["Room_Clos2_Spine"]
      attrs:
        facility:
          building_id: "Clos2"
          room_id: "Spine"
        hw_component: "SpineHW"

# Risk groups using fiber and facility domain models
risk_groups:
  # Fiber domain: Inter-clos fiber conduit (physical fiber cut affects all spine-spine links)
  - name: "Conduit_InterClos_C1"
    attrs:
      type: fiber_conduit
      fiber:
        path_id: "Clos1-Clos2"
        conduit_id: "InterClos-C1"
      distance_km: 5

  # Facility domain: Power zones and rooms in each Clos fabric
  - name: "PowerZone_Clos1_B1_PZA"
    attrs:
      type: power_zone
      facility:
        building_id: "Clos1"
        power_zone: "Clos1-B1-PZ-A"

  - name: "PowerZone_Clos2_B2_PZA"
    attrs:
      type: power_zone
      facility:
        building_id: "Clos2"
        power_zone: "Clos2-B2-PZ-A"

  - name: "Room_Clos1_Spine"
    attrs:
      type: room
      facility:
        building_id: "Clos1"
        room_id: "Spine"

  - name: "Room_Clos2_Spine"
    attrs:
      type: room
      facility:
        building_id: "Clos2"
        room_id: "Spine"

workflow:
  - type: BuildGraph
    name: build_graph

  # Forward direction analysis - equivalent to capacity_probe
  - type: MaxFlow
    name: capacity_analysis_forward
    source: my_clos1/b.*/t1
    target: my_clos2/b.*/t1
    mode: combine
    shortest_path: true
    flow_placement: PROPORTIONAL
    iterations: 1
    failure_policy: null

  # Reverse direction analysis - equivalent to capacity_probe with probe_reverse
  - type: MaxFlow
    name: capacity_analysis_reverse
    source: my_clos2/b.*/t1
    target: my_clos1/b.*/t1
    mode: combine
    shortest_path: true
    flow_placement: PROPORTIONAL
    iterations: 1
    failure_policy: null

  # Forward direction with EQUAL_BALANCED - equivalent to capacity_probe2
  - type: MaxFlow
    name: capacity_analysis_forward_balanced
    source: my_clos1/b.*/t1
    target: my_clos2/b.*/t1
    mode: combine
    shortest_path: true
    flow_placement: EQUAL_BALANCED
    iterations: 1
    failure_policy: null

  # Reverse direction with EQUAL_BALANCED - equivalent to capacity_probe2 with probe_reverse
  - type: MaxFlow
    name: capacity_analysis_reverse_balanced
    source: my_clos2/b.*/t1
    target: my_clos1/b.*/t1
    mode: combine
    shortest_path: true
    flow_placement: EQUAL_BALANCED
    iterations: 1
    failure_policy: null
