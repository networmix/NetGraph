# Test scenario 2: Hierarchical DSL with blueprints and multi-node expansions
# Tests complex network blueprints with mesh patterns and sub-topologies
seed: 2002

# Hierarchical DSL describing sub-topologies and multi-node expansions.
#
# Path Conventions:
# - All paths are relative to the current scope (blueprint instantiation path or network root).
# - Leading '/' is stripped and has no functional effect - '/leaf' and 'leaf' are equivalent.
# - In blueprints, paths resolve relative to the instantiation path (e.g., '/leaf' in a
#   blueprint instantiated as 'pod1' becomes 'pod1/leaf').
# - At top-level network, parent path is empty so '/SFO' and 'SFO' both become 'SFO'.
#
# Adjacency Patterns:
# - "mesh" cross-connects all nodes from source to all nodes from target, skipping self-loops.
# - "one_to_one" pairs up source[i] with target[i], also skipping self-loops.

blueprints:
  # A "blueprint" describes a reusable fragment of topology (e.g., a pattern).
  # It can be referenced in other blueprints or in the main 'network'.
  clos_2tier:
    nodes:
      leaf:
        count: 4
        template: leaf-{n}
      spine:
        count: 4
        template: spine-{n}

    links:
      - source: /leaf
        target: /spine
        pattern: mesh
        capacity: 100
        cost: 1000

  # Another blueprint referencing 'clos_2tier' as a sub-topology.
  city_cloud:
    nodes:
      clos_instance:
        # Uses the 'clos_2tier' blueprint but overrides some parameters.
        blueprint: clos_2tier
        params:
          # Override: more spine nodes and custom naming convention
          spine.count: 6
          spine.template: "myspine-{n}"

      edge_nodes:
        count: 4
        template: edge-{n}

    links:
      - source: /clos_instance/leaf
        target: /edge_nodes
        pattern: mesh
        capacity: 100
        cost: 1000

  # A minimal blueprint representing a single node.
  single_node:
    nodes:
      single:
        count: 1
        template: single-{n}

# -- Main network definition --
network:
  name: "6-node-l3-us-backbone"
  version: 1.1

  nodes:
    # 1) 'SEA' references the 'city_cloud' blueprint. This creates subgroups
    #    "SEA/clos_instance" and "SEA/edge_nodes" in the global scope.
    SEA:
      blueprint: city_cloud
      attrs:
        coords: [47.6062, -122.3321]

    # 2) 'SFO' references 'single_node' (one-node blueprint).
    SFO:
      blueprint: single_node
      attrs:
        coords: [37.7749, -122.4194]

    # Standalone nodes
    DEN:
      attrs:
        coords: [39.7392, -104.9903]
    DFW:
      attrs:
        coords: [32.8998, -97.0403]
    JFK:
      attrs:
        coords: [40.641766, -73.780968]
    DCA:
      attrs:
        coords: [38.907192, -77.036871]

  links:
    # Each adjacency definition uses "mesh" in this scenario. Self-loops are automatically skipped.
    - source: /SFO
      target: /DEN
      pattern: mesh
      capacity: 100
      cost: 7754
      attrs:
        distance_km: 1550.77

    - source: /SFO
      target: /DFW
      pattern: mesh
      capacity: 200
      cost: 10000
      attrs:
        distance_km: 2000

    - source: /SEA/edge_nodes
      target: /DEN
      pattern: mesh
      capacity: 100
      cost: 6846
      attrs:
        distance_km: 1369.13

    - source: /SEA/edge_nodes
      target: /DFW
      pattern: mesh
      capacity: 100
      cost: 9600
      attrs:
        distance_km: 1920

    # Additional direct links
    # Note that each link references existing nodes (e.g., DEN, DFW).
    # If multiple links exist between the same two nodes, they have unique IDs
    # generated by the code, but share the same source/target.
    - source: DEN
      target: DFW
      capacity: 400
      cost: 7102
      attrs:
        distance_km: 1420.28
    - source: DEN
      target: DFW
      capacity: 400
      cost: 7102
      attrs:
        distance_km: 1420.28
    - source: DEN
      target: JFK
      capacity: 200
      cost: 7500
      attrs:
        distance_km: 1500
    - source: DFW
      target: DCA
      capacity: 200
      cost: 8000
      attrs:
        distance_km: 1600
    - source: DFW
      target: JFK
      capacity: 200
      cost: 9500
      attrs:
        distance_km: 1900
    - source: JFK
      target: DCA
      capacity: 100
      cost: 1714
      attrs:
        distance_km: 342.69

failures:
  default:
    attrs:
      description: "Evaluate traffic routing under any single link failure."
    modes:
      - weight: 1.0
        rules:
          - scope: "link"
            mode: "choice"
            count: 1

demands:
  default:
    - source: SEA
      target: JFK
      volume: 50
    - source: SFO
      target: DCA
      volume: 50
    - source: SEA
      target: DCA
      volume: 50
    - source: SFO
      target: JFK
      volume: 50

workflow:
  - type: BuildGraph
    name: build_graph
