{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://netgraph.dev/schemas/scenario.json",
  "title": "NetGraph Scenario Schema",
  "description": "JSON Schema for NetGraph network scenario YAML files",
  "type": "object",
  "$defs": {
    "condition": {
      "type": "object",
      "description": "A single attribute condition for entity filtering",
      "properties": {
        "attr": {
          "type": "string",
          "description": "Attribute name to evaluate (supports dot-notation for nested attributes, e.g., 'hardware.vendor')"
        },
        "op": {
          "type": "string",
          "enum": [
            "==",
            "!=",
            ">",
            "<",
            ">=",
            "<=",
            "contains",
            "not_contains",
            "in",
            "not_in",
            "exists",
            "not_exists"
          ],
          "description": "Comparison operator"
        },
        "value": {
          "description": "Value to compare against (not required for exists/not_exists operators)"
        }
      },
      "required": [
        "attr",
        "op"
      ],
      "additionalProperties": false
    },
    "matchSpec": {
      "type": "object",
      "description": "Match specification for filtering entities by attribute conditions",
      "properties": {
        "logic": {
          "type": "string",
          "enum": [
            "and",
            "or"
          ],
          "description": "How to combine conditions (defaults vary by context: 'or' for links/demands, 'and' for membership rules)"
        },
        "conditions": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/condition"
          },
          "description": "List of conditions to evaluate"
        }
      },
      "required": [
        "conditions"
      ],
      "additionalProperties": false
    },
    "nodeSelector": {
      "type": "object",
      "description": "Node selector with path, group_by, match, and active_only",
      "properties": {
        "path": {
          "type": "string",
          "description": "Regex pattern on node.name"
        },
        "group_by": {
          "type": "string",
          "description": "Attribute name to group nodes by"
        },
        "match": {
          "$ref": "#/$defs/matchSpec"
        },
        "active_only": {
          "type": "boolean",
          "description": "Whether to exclude disabled nodes"
        }
      },
      "additionalProperties": false
    },
    "selectorOrString": {
      "oneOf": [
        {
          "type": "string"
        },
        {
          "$ref": "#/$defs/nodeSelector"
        }
      ]
    },
    "expandBlock": {
      "type": "object",
      "description": "Variable expansion block",
      "properties": {
        "vars": {
          "type": "object",
          "description": "Variable substitutions using ${var} syntax",
          "additionalProperties": {
            "type": "array",
            "items": {}
          }
        },
        "mode": {
          "type": "string",
          "enum": [
            "cartesian",
            "zip"
          ],
          "description": "How to combine variable lists (default: cartesian)"
        }
      },
      "additionalProperties": false
    },
    "linkProperties": {
      "type": "object",
      "description": "Common link properties (flattened, no wrapper)",
      "properties": {
        "capacity": {
          "type": "number",
          "description": "Link capacity"
        },
        "cost": {
          "type": "number",
          "description": "Link cost"
        },
        "disabled": {
          "type": "boolean",
          "description": "Whether the link is disabled"
        },
        "risk_groups": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Risk groups this link belongs to"
        },
        "attrs": {
          "type": "object",
          "description": "Additional link attributes",
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "nodeDefinition": {
      "type": "object",
      "description": "Node definition - either single node, counted group, blueprint reference, or nested nodes",
      "properties": {
        "blueprint": {
          "type": "string",
          "description": "Blueprint to instantiate"
        },
        "params": {
          "type": "object",
          "description": "Parameters to pass to the blueprint"
        },
        "count": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of nodes to create (distinguishes group from single node)"
        },
        "template": {
          "type": "string",
          "description": "Name template using {n} placeholder for sequential numbering"
        },
        "nodes": {
          "type": "object",
          "description": "Nested child nodes (inline hierarchy without blueprints)",
          "additionalProperties": {
            "$ref": "#/$defs/nodeDefinition"
          }
        },
        "attrs": {
          "type": "object",
          "description": "Node attributes"
        },
        "disabled": {
          "type": "boolean",
          "description": "Whether the node is disabled"
        },
        "risk_groups": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Risk groups this node belongs to"
        }
      },
      "additionalProperties": false
    },
    "linkDefinition": {
      "type": "object",
      "description": "Link definition with flattened properties",
      "properties": {
        "source": {
          "$ref": "#/$defs/selectorOrString",
          "description": "Source node selector or name"
        },
        "target": {
          "$ref": "#/$defs/selectorOrString",
          "description": "Target node selector or name"
        },
        "pattern": {
          "type": "string",
          "enum": [
            "mesh",
            "one_to_one"
          ],
          "description": "Connection pattern between source and target sets"
        },
        "count": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of parallel links to create"
        },
        "capacity": {
          "type": "number",
          "description": "Link capacity"
        },
        "cost": {
          "type": "number",
          "description": "Link cost"
        },
        "disabled": {
          "type": "boolean",
          "description": "Whether the link is disabled"
        },
        "risk_groups": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Risk groups this link belongs to"
        },
        "attrs": {
          "type": "object",
          "description": "Additional link attributes",
          "additionalProperties": true
        },
        "expand": {
          "$ref": "#/$defs/expandBlock"
        }
      },
      "required": [
        "source",
        "target"
      ],
      "additionalProperties": false
    }
  },
  "properties": {
    "vars": {
      "type": "object",
      "description": "YAML anchors and variable definitions for reuse throughout the scenario"
    },
    "seed": {
      "type": "integer",
      "description": "Master seed for reproducible random operations across the scenario"
    },
    "network": {
      "type": "object",
      "description": "Network topology definition",
      "properties": {
        "name": {
          "type": "string",
          "description": "Network name"
        },
        "version": {
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "number"
            }
          ],
          "description": "Network version"
        },
        "nodes": {
          "type": "object",
          "description": "Node definitions (single nodes or counted groups distinguished by 'count' field)",
          "additionalProperties": {
            "$ref": "#/$defs/nodeDefinition"
          }
        },
        "links": {
          "type": "array",
          "description": "Link definitions",
          "items": {
            "$ref": "#/$defs/linkDefinition"
          }
        },
        "node_rules": {
          "type": "array",
          "description": "Node override rules (post-expansion)",
          "items": {
            "type": "object",
            "properties": {
              "path": {
                "type": "string",
                "description": "Regex pattern on node.name"
              },
              "match": {
                "$ref": "#/$defs/matchSpec"
              },
              "attrs": {
                "type": "object"
              },
              "disabled": {
                "type": "boolean"
              },
              "risk_groups": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "expand": {
                "$ref": "#/$defs/expandBlock"
              }
            },
            "additionalProperties": false
          }
        },
        "link_rules": {
          "type": "array",
          "description": "Link override rules (post-expansion)",
          "items": {
            "type": "object",
            "properties": {
              "source": {
                "$ref": "#/$defs/selectorOrString"
              },
              "target": {
                "$ref": "#/$defs/selectorOrString"
              },
              "bidirectional": {
                "type": "boolean",
                "description": "Whether to match links in both directions"
              },
              "link_match": {
                "$ref": "#/$defs/matchSpec",
                "description": "Filter by the link's own attributes"
              },
              "capacity": {
                "type": "number"
              },
              "cost": {
                "type": "number"
              },
              "disabled": {
                "type": "boolean"
              },
              "risk_groups": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "attrs": {
                "type": "object"
              },
              "expand": {
                "$ref": "#/$defs/expandBlock"
              }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "blueprints": {
      "type": "object",
      "description": "Reusable network blueprint definitions",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "nodes": {
            "type": "object",
            "description": "Node definitions within the blueprint",
            "additionalProperties": {
              "$ref": "#/$defs/nodeDefinition"
            }
          },
          "links": {
            "type": "array",
            "description": "Link definitions within the blueprint",
            "items": {
              "$ref": "#/$defs/linkDefinition"
            }
          }
        },
        "additionalProperties": false
      }
    },
    "risk_groups": {
      "type": "array",
      "description": "Risk group definitions for failure modeling. Supports string shorthand: 'GroupName' is equivalent to {name: 'GroupName'}",
      "items": {
        "oneOf": [
          {
            "type": "string",
            "description": "String shorthand for simple risk group"
          },
          {
            "type": "object",
            "description": "Full risk group definition",
            "properties": {
              "name": {
                "type": "string",
                "description": "Unique risk group name"
              },
              "disabled": {
                "type": "boolean",
                "description": "Whether this risk group is disabled on load"
              },
              "attrs": {
                "type": "object",
                "description": "Additional metadata for the risk group"
              },
              "children": {
                "type": "array",
                "description": "Nested child risk groups",
                "items": {
                  "$ref": "#/properties/risk_groups/items"
                }
              },
              "membership": {
                "type": "object",
                "description": "Policy-based membership rule for auto-assigning entities to this risk group",
                "properties": {
                  "scope": {
                    "type": "string",
                    "enum": [
                      "node",
                      "link",
                      "risk_group"
                    ],
                    "description": "Type of entities to match"
                  },
                  "path": {
                    "type": "string",
                    "description": "Regex filter on entity name"
                  },
                  "match": {
                    "$ref": "#/$defs/matchSpec"
                  }
                },
                "required": [
                  "scope"
                ],
                "additionalProperties": false
              }
            },
            "required": [
              "name"
            ],
            "additionalProperties": false
          },
          {
            "type": "object",
            "description": "Dynamic risk group generation block",
            "properties": {
              "generate": {
                "type": "object",
                "description": "Generate risk groups from unique attribute values",
                "properties": {
                  "scope": {
                    "type": "string",
                    "enum": [
                      "node",
                      "link"
                    ],
                    "description": "Type of entities to group (node or link only)"
                  },
                  "group_by": {
                    "type": "string",
                    "description": "Attribute name to group by (supports dot-notation)"
                  },
                  "name": {
                    "type": "string",
                    "description": "Template for generated group names. Use ${value} as placeholder"
                  },
                  "path": {
                    "type": "string",
                    "description": "Regex filter on entity name"
                  },
                  "attrs": {
                    "type": "object",
                    "description": "Static attributes for generated groups"
                  }
                },
                "required": [
                  "scope",
                  "group_by",
                  "name"
                ],
                "additionalProperties": false
              }
            },
            "required": [
              "generate"
            ],
            "additionalProperties": false
          }
        ]
      }
    },
    "failures": {
      "type": "object",
      "description": "Named failure policies for simulation",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "attrs": {
            "type": "object",
            "description": "Policy metadata"
          },
          "expand_groups": {
            "type": "boolean",
            "description": "Whether to fail risk groups"
          },
          "expand_children": {
            "type": "boolean",
            "description": "Whether to recursively fail risk group children"
          },
          "modes": {
            "type": "array",
            "description": "Weighted mode list; exactly one mode is chosen per iteration.",
            "items": {
              "type": "object",
              "properties": {
                "weight": {
                  "type": "number",
                  "minimum": 0
                },
                "attrs": {
                  "type": "object"
                },
                "rules": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "scope": {
                        "type": "string",
                        "enum": [
                          "node",
                          "link",
                          "risk_group"
                        ],
                        "description": "What entities this rule applies to"
                      },
                      "path": {
                        "type": "string",
                        "description": "Regex filter on entity name"
                      },
                      "match": {
                        "$ref": "#/$defs/matchSpec"
                      },
                      "mode": {
                        "type": "string",
                        "enum": [
                          "all",
                          "choice",
                          "random"
                        ],
                        "description": "How to apply the rule"
                      },
                      "probability": {
                        "type": "number",
                        "minimum": 0,
                        "maximum": 1,
                        "description": "Probability for random mode"
                      },
                      "count": {
                        "type": "integer",
                        "minimum": 1,
                        "description": "Number of entities to affect for choice mode"
                      },
                      "weight_by": {
                        "type": "string",
                        "description": "Attribute name used for weighted sampling in choice mode"
                      }
                    },
                    "required": [
                      "scope"
                    ],
                    "additionalProperties": false
                  }
                }
              },
              "required": [
                "weight",
                "rules"
              ],
              "additionalProperties": false
            }
          }
        },
        "additionalProperties": false
      }
    },
    "demands": {
      "type": "object",
      "description": "Named traffic demand sets",
      "additionalProperties": {
        "type": "array",
        "description": "List of traffic demands",
        "items": {
          "type": "object",
          "properties": {
            "source": {
              "$ref": "#/$defs/selectorOrString",
              "description": "Source node selector"
            },
            "target": {
              "$ref": "#/$defs/selectorOrString",
              "description": "Target node selector"
            },
            "volume": {
              "type": "number",
              "description": "Traffic demand volume"
            },
            "priority": {
              "type": "integer",
              "description": "Priority class"
            },
            "mode": {
              "type": "string",
              "enum": [
                "combine",
                "pairwise"
              ],
              "description": "Expansion mode for source/target pairs"
            },
            "group_mode": {
              "type": "string",
              "enum": [
                "flatten",
                "per_group",
                "group_pairwise"
              ],
              "description": "How grouped nodes produce demands"
            },
            "expand": {
              "$ref": "#/$defs/expandBlock"
            },
            "flow_policy": {
              "description": "Routing policy configuration (preset name or inline object)",
              "oneOf": [
                {
                  "type": "string"
                },
                {
                  "type": "integer"
                },
                {
                  "type": "object"
                },
                {
                  "type": "null"
                }
              ]
            },
            "attrs": {
              "type": "object",
              "description": "Additional demand attributes"
            }
          },
          "required": [
            "source",
            "target"
          ],
          "additionalProperties": false
        }
      }
    },
    "components": {
      "type": "object",
      "description": "Hardware component library (preserved as-is)",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "component_type": {
            "type": "string"
          },
          "description": {
            "type": "string"
          },
          "capex": {
            "type": "number"
          },
          "power_watts": {
            "type": "number"
          },
          "power_watts_max": {
            "type": "number"
          },
          "capacity": {
            "type": "number"
          },
          "ports": {
            "type": "integer"
          },
          "count": {
            "type": "integer"
          },
          "attrs": {
            "type": "object"
          },
          "children": {
            "type": "object",
            "additionalProperties": {
              "type": "object",
              "additionalProperties": true
            }
          }
        },
        "additionalProperties": false
      }
    },
    "workflow": {
      "type": "array",
      "description": "Workflow steps to execute",
      "items": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "description": "Type of workflow step (BuildGraph, NetworkStats, MaxFlow, TrafficMatrixPlacement, MaximumSupportedDemand, CostPower)"
          },
          "name": {
            "type": "string",
            "description": "Step name"
          },
          "source": {
            "$ref": "#/$defs/selectorOrString",
            "description": "Source node selector"
          },
          "target": {
            "$ref": "#/$defs/selectorOrString",
            "description": "Target node selector"
          },
          "demand_set": {
            "type": "string",
            "description": "Name of demand set to use"
          },
          "failure_policy": {
            "type": [
              "string",
              "null"
            ],
            "description": "Name of failure policy to use (optional)"
          }
        },
        "required": [
          "type"
        ],
        "additionalProperties": true
      }
    }
  },
  "additionalProperties": false
}
